<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>D√≠a 1 ‚Äì Caf√© por Rango Altitudinal</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body { margin: 0; }
    #map { height: 100vh; }

    /* t√≠tulo centrado arriba */
    .map-title-top {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 14px;
      font: 16px/18px Arial, sans-serif;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,.25);
      z-index: 1000;
      text-align: center;
      pointer-events: none;
    }
    .map-title-top b { font-weight: 700; }

    .legend-custom {
      background: white;
      padding: 6px 8px;
      font: 12px/14px Arial, sans-serif;
      color: #222;
    }
    .count-box {
      background: rgba(255,255,255,0.95);
      padding: 6px 10px;
      font: 12px Arial, sans-serif;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
    }

    .leaflet-bottom.leaflet-right .leaflet-control-scale {
      margin-bottom: 70px;
      margin-right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 3px;
    }

    @media print {
      .leaflet-control,
      .map-title-top {
        display: none !important;
      }
      #map { height: 100vh; }
    }
  </style>
</head>
<body>
  <!-- t√≠tulo -->
  <div class="map-title-top">
    <b>Cobertura de caf√© 2017‚Äì2018 por Rango Altitudinal en Costa Rica</b><br>
    <small>Fuente: SNIT ‚Äì Nodo ICAFE / Nodo IGN</small>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- plugin WMTS -->
  <script>
    L.TileLayer.WMTS = L.TileLayer.extend({
      defaultWmtsParams: {
        service: 'WMTS',
        request: 'GetTile',
        version: '1.0.0',
        layer: '',
        style: '',
        tilematrixSet: '',
        format: 'image/png'
      },
      initialize: function (url, options) {
        this._url = url;
        const wmtsParams = L.extend({}, this.defaultWmtsParams);
        for (const i in options) {
          if (!this.options.hasOwnProperty(i) && i !== 'matrixIds') {
            wmtsParams[i] = options[i];
          }
        }
        this.wmtsParams = wmtsParams;
        L.setOptions(this, options);
      },
      getTileUrl: function (coords) {
        const tilematrix = this.wmtsParams.tilematrixSet + ':' + coords.z;
        const url = this._url;
        return (
          url +
          L.Util.getParamString(this.wmtsParams, url) +
          '&tilematrix=' + tilematrix +
          '&tilerow=' + coords.y +
          '&tilecol=' + coords.x
        );
      }
    });
    L.tileLayer.wmts = function (url, options) {
      return new L.TileLayer.WMTS(url, options);
    };
  </script>

  <script>
    // 1. mapa (esto es inicial, luego lo sobreescribimos con fitBounds+setView)
    const map = L.map("map").setView([9.9, -84.2], 7.5);

    // 2. capas raster SNIT
    const snitSombra = L.tileLayer.wmts(
      "https://geos1.snitcr.go.cr/ModelosIGN/wmts?",
      {
        layer: "IGN_MODELO_SOMBRAS_2017",
        style: "_empty",
        tilematrixSet: "EPSG:3857",
        format: "image/png",
        transparent: true,
        opacity: 0.3,
        attribution: "SNIT - IGN Modelo de Sombras 2017"
      }
    ).addTo(map);

    const snitMDE = L.tileLayer.wmts(
      "https://geos1.snitcr.go.cr/ModelosIGN/wmts?",
      {
        layer: "IGN_MDE_2017",
        style: "_empty",
        tilematrixSet: "EPSG:3857",
        format: "image/png",
        transparent: true,
        opacity: 0.5,
        attribution: "SNIT - IGN MDE 2017"
      }
    ).addTo(map);

    // 3. funci√≥n de color
    function getColor(rango) {
      if (!rango) return "#cccccc";
      if (rango === "<1100") return "#a1d99b";
      if (rango === "1100-1500") return "#31a354";
      return "#006d2c";
    }

    const overlayLayers = {};
    const regionLayers = {};

    // 4. cargar datos
    fetch("cafe_altura_4326.geojson")
      .then(r => r.json())
      .then(data => {
        let total = 0, bajo = 0, medio = 0, alto = 0;
        const regionesSet = new Set();

        data.features.forEach(f => {
          total++;
          const r = f.properties.rangoaltit;
          const reg = (f.properties.REGIONAL || "").trim();
          if (reg) regionesSet.add(reg);

          if (r === "<1100") bajo++;
          else if (r === "1100-1500") medio++;
          else alto++;
        });

        // capa principal
        const cafeLayer = L.geoJSON(data, {
          pointToLayer: (feature, latlng) => {
            const rango = feature.properties.rangoaltit;

            let styleOpts = {
              radius: 4,
              color: "#e0e0e0",
              weight: 0.4,
              fillColor: getColor(rango),
              fillOpacity: 0.65
            };

            if (rango === "<1100") {
              styleOpts.fillOpacity = 0.55;
            } else if (rango === "1100-1500") {
              styleOpts.radius = 6;
              styleOpts.color = "#00441b";
              styleOpts.weight = 1.4;
              styleOpts.fillOpacity = 0.9;
            } else {
              styleOpts.radius = 5;
              styleOpts.weight = 0.6;
            }

            const marker = L.circleMarker(latlng, styleOpts);

            marker.bindTooltip(
              `${feature.properties.Cant√≥n || feature.properties.Canton || "‚Äî"}<br>${rango || "‚Äî"}`,
              { direction: "top" }
            );
            marker.bindPopup(`
              <b>Cobertura de caf√© 2017-2018</b><br>
              Regi√≥n: ${feature.properties.REGIONAL || "‚Äî"}<br>
              Cant√≥n: ${feature.properties.Cant√≥n || feature.properties.Canton || "‚Äî"}<br>
              Distrito: ${feature.properties.Distrito || "‚Äî"}<br>
              Elevaci√≥n: ${feature.properties.elevacion ?? "‚Äî"} msnm<br>
              Rango altitudinal: ${rango || "‚Äî"}<br>
              √Årea (ha): ${Number(feature.properties.area_ha || 0).toFixed(2)}
            `);
            return marker;
          }
        }).addTo(map);

        overlayLayers["Caf√© 2017-2018 (puntos)"] = cafeLayer;

        // üëá encuadre fijo para Costa Rica
        const crBounds = [
          [7.9, -86.6],  // sudoeste
          [11.4, -82.1]  // noreste
        ];
        map.fitBounds(crBounds);

        // üîç acercar un poco al abrir (ajusta el zoom aqu√≠: 8.3, 8.5, etc.)
        map.setView([9.8, -84.4], 8.6);

        // por cada regi√≥n, una capa
        regionesSet.forEach(regionNombre => {
          const capaRegion = L.geoJSON(data, {
            filter: f => (f.properties.REGIONAL || "").trim() === regionNombre,
            pointToLayer: (f, latlng) =>
              L.circleMarker(latlng, {
                radius: 6,
                color: "#08519c",
                weight: 1,
                fillColor: "#6baed6",
                fillOpacity: 0.9
              }).bindPopup(`
                <b>Cobertura de caf√© 2017-2018</b><br>
                Regi√≥n: ${f.properties.REGIONAL || "‚Äî"}<br>
                Cant√≥n: ${f.properties.Cant√≥n || f.properties.Canton || "‚Äî"}<br>
                Rango altitudinal: ${f.properties.rangoaltit || "‚Äî"}
              `)
          });
          regionLayers[regionNombre] = capaRegion;
          overlayLayers[`Regi√≥n: ${regionNombre}`] = capaRegion;
        });

        // control de capas
        L.control.layers(
          {
            "SNIT - Modelo de sombras 2017": snitSombra,
            "SNIT - MDE 2017": snitMDE
          },
          overlayLayers,
          { collapsed: true }
        ).addTo(map);

        // contador
        const countControl = L.control({ position: "topleft" });
        countControl.onAdd = function () {
          const div = L.DomUtil.create("div", "count-box");
          const pctMedio = total ? ((medio / total) * 100).toFixed(1) : 0;
          div.innerHTML =
            `<b>Resumen de puntos</b><br>` +
            `Total: ${total.toLocaleString("es-CR")}<br>` +
            `&lt;1100 msnm: ${bajo.toLocaleString("es-CR")}<br>` +
            `1100‚Äì1500 msnm: ${medio.toLocaleString("es-CR")} (${pctMedio}%)<br>` +
            `&gt;1500 msnm: ${alto.toLocaleString("es-CR")}`;
          return div;
        };
        countControl.addTo(map);

        // zoom a regi√≥n cuando se active
        map.on("overlayadd", function (e) {
          if (e.layer && e.layer.getBounds) {
            const b = e.layer.getBounds();
            if (b.isValid()) {
              map.fitBounds(b, {
                padding: [40, 40],
                maxZoom: 10   // para que quede m√°s cerca
              });
            }
          }
        });
      });

    // capa opcional de l√≠mite nacional
    fetch("cr_limite.geojson")
      .then(r => {
        if (!r.ok) throw new Error("no existe cr_limite.geojson");
        return r.json();
      })
      .then(limite => {
        L.geoJSON(limite, {
          style: {
            color: "#222",
            weight: 1,
            fill: false
          }
        }).addTo(map);
      })
      .catch(() => {});

    // leyenda
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend-custom");
      const grades = ["<1100", "1100-1500", ">1500"];
      const labels = ["< 1 100 msnm", "1 100 ‚Äì 1 500 msnm", "> 1 500 msnm"];
      div.innerHTML += "<b>Rango Altitudinal</b><br>";
      for (let i = 0; i < grades.length; i++) {
        div.innerHTML +=
          `<i style="background:${getColor(grades[i])};width:12px;height:12px;display:inline-block;margin-right:4px;border:1px solid #fff;"></i>` +
          labels[i] + "<br>";
      }
      return div;
    };
    legend.addTo(map);

    // escala
    L.control.scale({
      position: "bottomleft",
      imperial: false,
      maxWidth: 120
    }).addTo(map);
  </script>
</body>
</html>









